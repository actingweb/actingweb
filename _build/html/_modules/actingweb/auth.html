
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>actingweb.auth &#8212; ActingWeb 2.6.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for actingweb.auth</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">actingweb</span><span class="w"> </span><span class="kn">import</span> <span class="n">actor</span><span class="p">,</span> <span class="n">oauth</span><span class="p">,</span> <span class="n">trust</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">actingweb</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">config_class</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">actingweb.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">TRUSTEE_CREATOR</span>

<span class="c1"># This is where each path and subpath in actingweb is assigned an authentication type</span>
<span class="c1"># Fairly simple: /oauth is always oauth, /www can be either basic+trust or</span>
<span class="c1"># oauth through config.py, and everything else is basic+trust</span>


<div class="viewcode-block" id="select_auth_type"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.select_auth_type">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">select_auth_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">subpath</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Selects authentication type based on path and subpath.</span>

<span class="sd">    Currently are only basic and oauth supported. Peer auth is automatic if an Authorization Bearer &lt;token&gt; header is</span>
<span class="sd">    included in the http request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;oauth&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;oauth&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;www&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">www_auth</span> <span class="k">if</span> <span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;basic&quot;</span>
    <span class="k">if</span> <span class="n">subpath</span> <span class="o">==</span> <span class="s2">&quot;oauth&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;oauth&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;basic&quot;</span></div>


<div class="viewcode-block" id="add_auth_response"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.add_auth_response">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">add_auth_response</span><span class="p">(</span><span class="n">appreq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auth_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Called after init_actingweb() if add_response was set to False, and now responses should be added.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">appreq</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">auth_obj</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;add_auth_response: &quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth_obj</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">])</span>
        <span class="o">+</span> <span class="s2">&quot;:&quot;</span>
        <span class="o">+</span> <span class="n">auth_obj</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">appreq</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">auth_obj</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span> <span class="n">auth_obj</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">auth_obj</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">302</span><span class="p">:</span>
        <span class="n">appreq</span><span class="o">.</span><span class="n">set_redirect</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">auth_obj</span><span class="o">.</span><span class="n">redirect</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">auth_obj</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
        <span class="n">appreq</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Authentication required&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">auth_obj</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">appreq</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="init_actingweb"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.init_actingweb">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">init_actingweb</span><span class="p">(</span>
    <span class="n">appreq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">actor_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">subpath</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">add_response</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialises actingweb by loading a config object, an actor object, and authentication object.</span>


<span class="sd">    More details about the authentication can be found in the auth object. If add_response is True,</span>
<span class="sd">    appreq.response</span>
<span class="sd">    will be changed according to authentication result. If False, appreq will not be touched.</span>
<span class="sd">    authn_done (bool), response[&#39;code&#39;], response[&#39;text&#39;], and response[&#39;headers&#39;] will indicate results of</span>
<span class="sd">    the authentication process</span>
<span class="sd">    and need to be acted upon.</span>
<span class="sd">    200 is access approved</span>
<span class="sd">    302 is redirect and auth_obj.redirect contains redirect location where response must be redirected</span>
<span class="sd">    401 is authentication required, response[&#39;headers&#39;] must be added to response</span>
<span class="sd">    403 is forbidden, text in response[&#39;text&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fullpath</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">subpath</span>
    <span class="n">auth_type</span> <span class="o">=</span> <span class="n">select_auth_type</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">subpath</span><span class="o">=</span><span class="n">subpath</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">auth_obj</span> <span class="o">=</span> <span class="n">Auth</span><span class="p">(</span><span class="n">actor_id</span><span class="p">,</span> <span class="n">auth_type</span><span class="o">=</span><span class="n">auth_type</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_obj</span><span class="o">.</span><span class="n">actor</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">add_response</span> <span class="ow">and</span> <span class="n">appreq</span> <span class="ow">and</span> <span class="n">appreq</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="n">appreq</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;Actor not found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">auth_obj</span><span class="o">.</span><span class="n">check_authentication</span><span class="p">(</span><span class="n">appreq</span><span class="o">=</span><span class="n">appreq</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fullpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">add_response</span> <span class="ow">and</span> <span class="n">appreq</span> <span class="ow">and</span> <span class="n">appreq</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
        <span class="n">add_auth_response</span><span class="p">(</span><span class="n">appreq</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="n">auth_obj</span><span class="p">)</span>
    <span class="c1"># Initialize the on_aw object with auth (.actor) and webobj (.config) for functions in on_aw</span>
    <span class="k">if</span> <span class="n">appreq</span> <span class="ow">and</span> <span class="n">appreq</span><span class="o">.</span><span class="n">on_aw</span><span class="p">:</span>
        <span class="n">appreq</span><span class="o">.</span><span class="n">on_aw</span><span class="o">.</span><span class="n">aw_init</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">auth_obj</span><span class="p">,</span> <span class="n">webobj</span><span class="o">=</span><span class="n">appreq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auth_obj</span><span class="o">.</span><span class="n">actor</span><span class="p">,</span> <span class="n">auth_obj</span></div>


<div class="viewcode-block" id="Auth"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Auth</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The auth class handles authentication and authorisation for the various schemes supported.</span>

<span class="sd">    The helper function init_actingweb() can be used to give you an auth object and do authentication (or can be called</span>
<span class="sd">    directly).</span>
<span class="sd">    The check_authentication() function checks the various authentication schemes against the path and does proper</span>
<span class="sd">    authentication.</span>
<span class="sd">    There are three types supported: basic (using creator credentials), token (received when trust is created), or</span>
<span class="sd">    oauth (used to bind</span>
<span class="sd">    an actor to an oauth-enabled external service, as well as to log into /www path where interactive web functionality</span>
<span class="sd">    of the actor is available).</span>
<span class="sd">    The check_authorisation() function validates the authenticated user against the config.py access list.</span>
<span class="sd">    check_token_auth() can be called from outside the class to do a simple peer/bearer token verification.</span>
<span class="sd">    The OAuth helper functions are used to:</span>
<span class="sd">    process_oauth_callback() - process an OAuth callback as part of an OAuth flow and exchange code with a valid token</span>
<span class="sd">    validate_oauth_token() - validate and, if necessary, refresh a token</span>
<span class="sd">    set_cookie_on_cookie_redirect() - set a session cookie in the browser to the token value (called AFTER OAuth has</span>
<span class="sd">    been done!)</span>

<span class="sd">    The response[], acl[], and authn_done variables are useful outside Auth(). authn_done is set when authentication has</span>
<span class="sd">    been done and a final authentication status can be found in response[].</span>

<span class="sd">         self.response = {</span>

<span class="sd">            &quot;code&quot;: 403,                # Result code (http)</span>
<span class="sd">            &quot;text&quot;: &quot;Forbidden&quot;,        # Proposed response text</span>
<span class="sd">            &quot;headers&quot;: [],              # Headers to add to response after authentication has been done</span>

<span class="sd">        }</span>

<span class="sd">        self.acl = {</span>

<span class="sd">            &quot;authenticated&quot;: False, # Has authentication been verified and passed?</span>
<span class="sd">            &quot;authorised&quot;: False,    # Has authorisation been done and appropriate acls set?</span>
<span class="sd">            &quot;rights&quot;: &#39;&#39;,           # &quot;a&quot;, &quot;r&quot; (approve or reject)</span>
<span class="sd">            &quot;relationship&quot;: None,   # E.g. creator, friend, admin, etc</span>
<span class="sd">            &quot;peerid&quot;: &#39;&#39;,           # Peerid if there is a relationship</span>
<span class="sd">            &quot;approved&quot;: False,      # True if the peer is approved</span>

<span class="sd">        }</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor_id</span><span class="p">,</span> <span class="n">auth_type</span><span class="o">=</span><span class="s2">&quot;basic&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config_class</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookie_redirect</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">auth_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trust</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Proposed response code after check_authentication() or authorise() have been called</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">403</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Forbidden&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="c1"># Whether authentication is complete or not (depends on flow)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authn_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># acl stores the actual verified credentials and access rights after</span>
        <span class="c1"># authentication and authorisation have been done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acl</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;authenticated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Has authentication been verified and passed?</span>
            <span class="s2">&quot;authorised&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Has authorisation been done and appropriate acls set?</span>
            <span class="s2">&quot;rights&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;a&quot;, &quot;r&quot; (approve or reject)</span>
            <span class="s2">&quot;relationship&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># E.g. creator, friend, admin, etc</span>
            <span class="s2">&quot;peerid&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># Peerid if there is a relationship</span>
            <span class="s2">&quot;approved&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># True if the peer is approved</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">Actor</span><span class="p">(</span><span class="n">actor_id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">OAuth</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expiry</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_expiry</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>
        <span class="c1"># We need to initialise oauth for use towards the external oauth service</span>
        <span class="c1"># Property name used to set self.token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_property</span> <span class="o">=</span> <span class="s2">&quot;oauth_token&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">oauth_token</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">OAuth</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expiry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">oauth_token_expiry</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_expiry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">oauth_refresh_token_expiry</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">oauth_refresh_token</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;basic&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">realm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">auth_realm</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;oauth&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">enabled</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="s2">&quot;oauth_token&quot;</span>
                <span class="n">redir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">cookie_redirect</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">redir</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cookie_redirect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root</span> <span class="o">+</span> <span class="n">redir</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cookie_redirect</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;/oauth&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__process_oauth_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No token in response&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expiry</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">oauth_token_expiry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiry</span>
        <span class="k">if</span> <span class="s2">&quot;refresh_token&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;refresh_token_expires_in&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refresh_expiry</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;refresh_token_expires_in&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Set a default expiry 12 months ahead</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refresh_expiry</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="p">(</span><span class="mi">365</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">oauth_refresh_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">oauth_refresh_token_expiry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_expiry</span>

<div class="viewcode-block" id="Auth.process_oauth_callback"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth.process_oauth_callback">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_oauth_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called when a callback is received as part of an OAuth flow to exchange code for a bearer token.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Call to processOauthCallback() with oauth disabled.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">oauth_request_token</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="p">(</span><span class="n">result</span> <span class="ow">and</span> <span class="s2">&quot;access_token&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No token in response&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__process_oauth_accept</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Auth.validate_oauth_token"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth.validate_oauth_token">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_oauth_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called to validate the token as part of a web-based flow.</span>

<span class="sd">        Returns the redirect URI to send back to the browser or empty string.</span>
<span class="sd">        If lazy is true, refresh_token is used only if &lt; 24h until expiry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiry</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">oauth_redirect_uri</span><span class="p">(</span>
                    <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">creator</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># Is the token still valid?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiry</span> <span class="ow">and</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expiry</span><span class="p">)</span> <span class="o">-</span> <span class="mf">20.0</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Has refresh_token expired?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_expiry</span> <span class="ow">and</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_expiry</span><span class="p">)</span> <span class="o">-</span> <span class="mf">20.0</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">oauth_redirect_uri</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Do we have more than a day until refresh token expiry?</span>
        <span class="k">if</span> <span class="n">lazy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_expiry</span> <span class="ow">and</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_expiry</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">3600.0</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Refresh the token</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">oauth_refresh_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">oauth_redirect_uri</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__process_oauth_accept</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="Auth.oauth_get"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth.oauth_get">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">oauth_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to call GET from the attached oauth service.</span>

<span class="sd">        Uses oauth.get_request(), but refreshes token if necessary.</span>
<span class="sd">        The function fails if token is invalid and no refresh is</span>
<span class="sd">        possible. For web-based flows, validate_oauth_token() needs</span>
<span class="sd">        to be used to validate token and get redirect URI for new</span>
<span class="sd">        authorization flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="n">code1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">last_response_code</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">201</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ret</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">403</span><span class="p">):</span>
            <span class="n">refresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">oauth_refresh_token</span><span class="p">(</span><span class="n">refresh_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Tried to refresh token and failed for Actor(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__process_oauth_accept</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
                <span class="n">ret2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">code2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">last_response_code</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="mi">500</span>
                <span class="k">if</span> <span class="n">ret2</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">ret2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">code2</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">or</span> <span class="n">code2</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ret2</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Auth.oauth_head"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth.oauth_head">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">oauth_head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to call HEAD from the attached oauth service.</span>

<span class="sd">        Uses oauth.head_request((), but refreshes token if necessary.</span>
<span class="sd">        The function fails if token is invalid and no refresh is</span>
<span class="sd">        possible. For web-based flows, validate_oauth_token() needs</span>
<span class="sd">        to be used to validate token and get redirect URI for new</span>
<span class="sd">        authorization flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">head_request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="n">code1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">last_response_code</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">201</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ret</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">403</span><span class="p">):</span>
            <span class="n">refresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">oauth_refresh_token</span><span class="p">(</span><span class="n">refresh_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Tried to refresh token and failed for Actor(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__process_oauth_accept</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
                <span class="n">ret2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">head_request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">code2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">last_response_code</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="mi">500</span>
                <span class="k">if</span> <span class="n">ret2</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">ret2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">code2</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">or</span> <span class="n">code2</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ret2</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Auth.oauth_delete"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth.oauth_delete">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">oauth_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to call DELETE from the attached oauth service.</span>

<span class="sd">        Uses oauth.delete_request((), but refreshes token if necessary.</span>
<span class="sd">        The function fails if token is invalid and no refresh is</span>
<span class="sd">        possible. For web-based flows, validate_oauth_token() needs</span>
<span class="sd">        to be used to validate token and get redirect URI for new</span>
<span class="sd">        authorization flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">delete_request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
        <span class="n">code1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">last_response_code</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="p">(</span><span class="n">code1</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">403</span><span class="p">):</span>
            <span class="n">refresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">oauth_refresh_token</span><span class="p">(</span><span class="n">refresh_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Tried to refresh token and failed for Actor(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__process_oauth_accept</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
                <span class="n">ret2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">delete_request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">code2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">last_response_code</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="mi">500</span>
                <span class="k">if</span> <span class="n">ret2</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">ret2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">code2</span> <span class="o">==</span> <span class="mi">204</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ret2</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Auth.oauth_post"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth.oauth_post">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">oauth_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">urlencode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to call POST from the attached oauth service.</span>

<span class="sd">        Uses oauth.post_request(), but refreshes token if necessary.</span>
<span class="sd">        The function fails if token is invalid and no refresh is</span>
<span class="sd">        possible. For web-based flows, validate_oauth_token() needs</span>
<span class="sd">        to be used to validate token and get redirect URI for new</span>
<span class="sd">        authorization flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">post_request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">urlencode</span><span class="o">=</span><span class="n">urlencode</span><span class="p">)</span>
        <span class="n">code1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">last_response_code</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">201</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="p">(</span><span class="n">code1</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">403</span><span class="p">):</span>
            <span class="n">refresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">oauth_refresh_token</span><span class="p">(</span><span class="n">refresh_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Tried to refresh token and failed for Actor(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__process_oauth_accept</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
                <span class="n">ret2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">post_request</span><span class="p">(</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">urlencode</span><span class="o">=</span><span class="n">urlencode</span>
                <span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">code2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">last_response_code</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="mi">500</span>
                <span class="k">if</span> <span class="n">ret2</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">ret2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">code2</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">or</span> <span class="n">code2</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ret2</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Auth.oauth_put"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth.oauth_put">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">oauth_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">urlencode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to call PUT from the attached oauth service.</span>

<span class="sd">        Uses oauth.put_request(), but refreshes token if necessary.</span>
<span class="sd">        The function fails if token is invalid and no refresh is</span>
<span class="sd">        possible. For web-based flows, validate_oauth_token() needs</span>
<span class="sd">        to be used to validate token and get redirect URI for new</span>
<span class="sd">        authorization flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">put_request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">urlencode</span><span class="o">=</span><span class="n">urlencode</span><span class="p">)</span>
        <span class="n">code1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">last_response_code</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">201</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="p">(</span><span class="n">code1</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">or</span> <span class="n">code1</span> <span class="o">==</span> <span class="mi">403</span><span class="p">):</span>
            <span class="n">refresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">oauth_refresh_token</span><span class="p">(</span><span class="n">refresh_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Tried to refresh token and failed for Actor(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__process_oauth_accept</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
                <span class="n">ret2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">put_request</span><span class="p">(</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">urlencode</span><span class="o">=</span><span class="n">urlencode</span>
                <span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">code2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span><span class="o">.</span><span class="n">last_response_code</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth</span> <span class="k">else</span> <span class="mi">500</span>
                <span class="k">if</span> <span class="n">ret2</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">ret2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">code2</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">or</span> <span class="n">code2</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ret2</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># Called from a www page (browser access) to verify that a cookie has been</span>
    <span class="c1"># set to the actor&#39;s valid token.</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__check_cookie_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appreq</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">appreq</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookie</span> <span class="ow">in</span> <span class="n">appreq</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
                <span class="n">authz</span> <span class="o">=</span> <span class="n">appreq</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cookie</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">authz</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">appreq</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refresh&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">appreq</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refresh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
            <span class="p">):</span>
                <span class="c1"># Clear cookie and do a refresh if refresh=True is in GET param</span>
                <span class="n">authz</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">authz</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiry</span> <span class="ow">and</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expiry</span><span class="p">)</span> <span class="o">-</span> <span class="mf">20.0</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Authorization cookie header matches a valid token&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;creator&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;authenticated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ok&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">authn_done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">authz</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Authorization cookie header does not match a valid token&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">403</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Forbidden&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">authn_done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookie_redirect</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cookie redirect already set!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">cookie_redirect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="n">path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cookie_redirect</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">302</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Auth.set_cookie_on_cookie_redirect"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth.set_cookie_on_cookie_redirect">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_cookie_on_cookie_redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appreq</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called after successful auth to set the cookie with the token value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookie_redirect</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Trying to set cookie when no token value can be found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting Authorization cookie: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">))</span>
        <span class="n">appreq</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cookie</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">),</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">1209600</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">appreq</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_redirect</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cookie_redirect</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">cookie_redirect</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">__check_basic_auth_creator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appreq</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;basic&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Trying to do basic auth when auth type is not basic&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">403</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Forbidden&quot;</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">passphrase</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Trying to do basic auth when no passphrase value can be found.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">403</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Forbidden&quot;</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;Authorization&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">appreq</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">][</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;Basic realm=&quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">realm</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">401</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Authentication required&quot;</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">authz</span> <span class="o">=</span> <span class="n">appreq</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span>
        <span class="p">(</span><span class="n">basic</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span> <span class="o">=</span> <span class="n">authz</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">basic</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;basic&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">403</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No basic auth in Authorization header&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No basic auth in Authorization header&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authn_done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">au</span> <span class="o">=</span> <span class="n">authz</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">au</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">au</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">au</span><span class="p">)</span>
        <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">or</span> <span class="n">username</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">creator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">403</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Invalid username or password&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wrong creator username&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">or</span> <span class="n">password</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">passphrase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">403</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Invalid username or password&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Wrong creator passphrase(&quot;</span>
                <span class="o">+</span> <span class="n">password</span>
                <span class="o">+</span> <span class="s2">&quot;) correct(&quot;</span>
                <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">passphrase</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;creator&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;authenticated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ok&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Auth.check_token_auth"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth.check_token_auth">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_token_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appreq</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called with an http request to check the Authorization header and validate if we have a peer with</span>
<span class="sd">        this token.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;Authorization&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">appreq</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">appreq</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span>
        <span class="p">(</span><span class="n">bearer</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bearer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;bearer&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authn_done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">trustee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">trustee_root</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="c1"># If trustee_root is set, creator name is &#39;trustee&#39; and</span>
        <span class="c1"># bit strength of passphrase is &gt; 80, use passphrase as</span>
        <span class="c1"># token</span>
        <span class="k">if</span> <span class="n">trustee</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">creator</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">TRUSTEE_CREATOR</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">passphrase</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">passphrase</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">94</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">passphrase</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRUSTEE_CREATOR</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;approved&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;authenticated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ok&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">passphrase</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Attempted trustee bearer token auth with &lt;80 bit strength token.&quot;</span>
                <span class="p">)</span>
        <span class="n">tru</span> <span class="o">=</span> <span class="n">trust</span><span class="o">.</span><span class="n">Trust</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">new_trust</span> <span class="o">=</span> <span class="n">tru</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_trust</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found trust with token: (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_trust</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="n">new_trust</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Peer == actor!!&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">new_trust</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_trust</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_trust</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_trust</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;approved&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_trust</span><span class="p">[</span><span class="s2">&quot;approved&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;authenticated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ok&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">new_trust</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trust</span> <span class="o">=</span> <span class="n">new_trust</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Auth.check_authentication"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth.check_authentication">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_authentication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appreq</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks authentication in appreq, redirecting back to path if oauth is done.&quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking authentication, token auth...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_token_auth</span><span class="p">(</span><span class="n">appreq</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;oauth&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking authentication, oauth cookie...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__check_cookie_auth</span><span class="p">(</span><span class="n">appreq</span><span class="o">=</span><span class="n">appreq</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;basic&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking authentication, basic auth...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__check_basic_auth_creator</span><span class="p">(</span><span class="n">appreq</span><span class="o">=</span><span class="n">appreq</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Authentication done, and failed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authn_done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">403</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Forbidden&quot;</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Auth.check_authorisation"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.auth.Auth.check_authorisation">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_authorisation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">subpath</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">approved</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if the authenticated user has acl access rights in config.py.</span>

<span class="sd">        Takes the path, subpath, method, and peerid of the path (if auth user</span>
<span class="sd">        is different from the peer that owns the path, e.g. creator). If approved</span>
<span class="sd">        is False, then the trust relationship does not need to be approved for</span>
<span class="sd">        access&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">approved</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;approved&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Rejected authorization because trust relationship is not approved.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]:</span>
            <span class="n">relationship</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">relationship</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;authorised&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;rights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subpath</span><span class="p">:</span>
            <span class="n">subpath</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">fullpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">subpath</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># ACLs: (&#39;role&#39;, &#39;path&#39;, &#39;METHODS&#39;, &#39;access&#39;)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Testing access for (&quot;</span>
            <span class="o">+</span> <span class="n">relationship</span>
            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="s2">&quot;) on (&quot;</span>
            <span class="o">+</span> <span class="n">fullpath</span>
            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="o">+</span> <span class="n">peerid</span>
            <span class="o">+</span> <span class="s2">&quot;) using method &quot;</span>
            <span class="o">+</span> <span class="n">method</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">acl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">access</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;authenticated&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">acl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">acl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;any&quot;</span>
                <span class="ow">and</span> <span class="n">acl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">relationship</span>
                <span class="ow">and</span> <span class="n">acl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;owner&quot;</span>
            <span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># no match on relationship</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">acl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">relationship</span>
                <span class="ow">or</span> <span class="n">acl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span>
                <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">acl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">acl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;owner&quot;</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">peerid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">peerid</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">fullpath</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">acl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">acl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">acl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="s2">&quot;rights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Granted &quot;</span> <span class="o">+</span> <span class="n">acl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; access with ACL:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">acl</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">ActingWeb</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">README - actingweb - an ActingWeb Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/developers.html">ActingWeb Developer Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/actingweb-spec.html">ActingWeb Specification - version 1.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/actingweb.html">actingweb code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG.html">CHANGELOG</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2020, Greger Teigre Wedel.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>