
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>actingweb.actor &#8212; ActingWeb 2.6.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for actingweb.actor</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urlfetch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">actingweb</span><span class="w"> </span><span class="kn">import</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">peertrustee</span><span class="p">,</span> <span class="nb">property</span><span class="p">,</span> <span class="n">subscription</span><span class="p">,</span> <span class="n">trust</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">actingweb.constants</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DEFAULT_CREATOR</span><span class="p">,</span>
    <span class="n">TRUSTEE_CREATOR</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="ActorError"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.ActorError">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ActorError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception class for Actor-related errors.&quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="ActorNotFoundError"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.ActorNotFoundError">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ActorNotFoundError</span><span class="p">(</span><span class="n">ActorError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when an actor cannot be found.&quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="InvalidActorDataError"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.InvalidActorDataError">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">InvalidActorDataError</span><span class="p">(</span><span class="n">ActorError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when actor data is invalid or corrupted.&quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="PeerCommunicationError"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.PeerCommunicationError">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">PeerCommunicationError</span><span class="p">(</span><span class="n">ActorError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when communication with peer actors fails.&quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="TrustRelationshipError"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.TrustRelationshipError">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">TrustRelationshipError</span><span class="p">(</span><span class="n">ActorError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when trust relationship operations fail.&quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="DummyPropertyClass"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.DummyPropertyClass">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">DummyPropertyClass</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Only used to deprecate get_property() in 2.4.4&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span></div>


<div class="viewcode-block" id="Actor"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Actor</span><span class="p">:</span>

    <span class="c1">###################</span>
    <span class="c1"># Basic operations</span>
    <span class="c1">###################</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">property_list</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subs_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passphrase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">actor_id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DbActor</span><span class="o">.</span><span class="n">DbActor</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">actor_id</span> <span class="ow">and</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">InternalStore</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="n">actor_id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">property</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">PropertyStore</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="n">actor_id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">property</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="n">actor_id</span><span class="p">)</span>

<div class="viewcode-block" id="Actor.get_peer_info"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get_peer_info">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_peer_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Contacts an another actor over http/s to retrieve meta information</span>
<span class="sd">        :param url: Root URI of a remote actor</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        :return: The json response from the /meta path in the data element and last_response_code/last_response_message</span>
<span class="sd">        set to the results of the https request</span>
<span class="sd">        :Example:</span>

<span class="sd">        &gt;&gt;&gt;{</span>
<span class="sd">        &gt;&gt;&gt;    &quot;last_response_code&quot;: 200,</span>
<span class="sd">        &gt;&gt;&gt;    &quot;last_response_message&quot;: &quot;OK&quot;,</span>
<span class="sd">        &gt;&gt;&gt;    &quot;data&quot;:{}</span>
<span class="sd">        &gt;&gt;&gt;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting peer info at url(</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/meta&quot;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;last_response_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="s2">&quot;last_response_message&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got peer info from url(</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">) with body(</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;last_response_code&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Actor.get"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves an actor from storage or initialises if it does not exist&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">actor_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">actor_id</span><span class="p">:</span>
            <span class="n">actor_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="n">actor_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">passphrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="p">[</span><span class="s2">&quot;passphrase&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">InternalStore</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">property</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">PropertyStore</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">force_email_prop_as_creator</span><span class="p">:</span>
                <span class="n">em</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">email</span>
                <span class="k">if</span> <span class="n">em</span> <span class="ow">and</span> <span class="n">em</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="n">em</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">passphrase</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span></div>

<div class="viewcode-block" id="Actor.get_from_property"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get_from_property">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_from_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;oauthId&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise an actor by matching on a stored property.</span>

<span class="sd">        Use with caution as the property&#39;s value de-facto becomes</span>
<span class="sd">        a security token. If multiple properties are found with the</span>
<span class="sd">        same value, no actor will be initialised.</span>
<span class="sd">        Also note that this is a costly operation as all properties</span>
<span class="sd">        of this type will be retrieved and proceessed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">actor_id</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get_actor_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">actor_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">passphrase</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="n">actor_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Actor.get_from_creator"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get_from_creator">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_from_creator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">creator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise an actor by matching on creator.</span>

<span class="sd">        If unique_creator config is False, then no actor will be initialised.</span>
<span class="sd">        Likewise, if multiple properties are found with the same value (due to earlier</span>
<span class="sd">        uniqueness off).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passphrase</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">unique_creator</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DbActor</span><span class="o">.</span><span class="n">DbActor</span><span class="p">()</span><span class="o">.</span><span class="n">get_by_creator</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="n">creator</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exists</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="n">exists</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Actor.create"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.create">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">creator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">passphrase</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">actor_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">delete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;Creates a new actor and persists it.</span>

<span class="sd">        If delete is True, any existing actors with same creator value</span>
<span class="sd">        will be deleted. If it is False, the one with the correct passphrase</span>
<span class="sd">        will be chosen (if any)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">url</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">seed</span> <span class="o">+=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">creator</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">creator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">DEFAULT_CREATOR</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">unique_creator</span><span class="p">:</span>
            <span class="n">in_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DbActor</span><span class="o">.</span><span class="n">DbActor</span><span class="p">()</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">in_db</span><span class="o">.</span><span class="n">get_by_creator</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                <span class="c1"># If uniqueness is turned on at a later point, we may have multiple accounts</span>
                <span class="c1"># with creator as &quot;creator&quot;. Check if we have an internal value &quot;email&quot; and then</span>
                <span class="c1"># set creator to the email address.</span>
                <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">exists</span><span class="p">:</span>
                        <span class="n">anactor</span> <span class="o">=</span> <span class="n">Actor</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
                        <span class="n">anactor</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">force_email_prop_as_creator</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">==</span> <span class="n">DEFAULT_CREATOR</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">exists</span><span class="p">:</span>
                            <span class="n">anactor</span> <span class="o">=</span> <span class="n">Actor</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
                            <span class="n">em</span> <span class="o">=</span> <span class="n">anactor</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">email</span> <span class="k">if</span> <span class="n">anactor</span><span class="o">.</span><span class="n">store</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">em</span><span class="p">:</span>
                                <span class="n">anactor</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="n">em</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">exists</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;passphrase&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">passphrase</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">in_db</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">passphrase</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;passphrase&quot;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">]</span>
                            <span class="k">return</span> <span class="kc">True</span>
                        <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">passphrase</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">passphrase</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">passphrase</span> <span class="o">=</span> <span class="n">passphrase</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">passphrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">new_token</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">actor_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">actor_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">new_uuid</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DbActor</span><span class="o">.</span><span class="n">DbActor</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">passphrase</span><span class="p">,</span> <span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">InternalStore</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">property</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">PropertyStore</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Actor.modify"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.modify">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">modify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">creator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">creator</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempted modify of actor with no handle or no param changed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">creator</span><span class="p">:</span>
            <span class="n">creator</span> <span class="o">=</span> <span class="n">creator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">creator</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">creator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="n">creator</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Actor.delete"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.delete">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes an actor and cleans up all relevant stored data&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempted delete of actor with no handle&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_peer_trustee</span><span class="p">(</span><span class="n">shorttype</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">property_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">property_list</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">Properties</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">property_list</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">subs</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">Subscriptions</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">trusts</span> <span class="o">=</span> <span class="n">trust</span><span class="o">.</span><span class="n">Trusts</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">relationships</span> <span class="o">=</span> <span class="n">trusts</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">relationships</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">relationships</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;peerid&quot;</span> <span class="ow">in</span> <span class="n">rel</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_reciprocal_trust</span><span class="p">(</span><span class="n">peerid</span><span class="o">=</span><span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;peerid&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">delete_peer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">trusts</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">Buckets</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">buckets</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

    <span class="c1">######################</span>
    <span class="c1"># Advanced operations</span>
    <span class="c1">######################</span>

<div class="viewcode-block" id="Actor.set_property"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.set_property">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets an actor&#39;s property name to value. (DEPRECATED, use actor&#39;s property store!)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Actor.get_property"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get_property">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves a property object named name. (DEPRECATED, use actor&#39;s property store!)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DummyPropertyClass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Actor.delete_property"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.delete_property">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes a property name. (DEPRECATED, use actor&#39;s property store!)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">property</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Actor.delete_properties"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.delete_properties">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes all properties.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">property_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">property_list</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">Properties</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">property_list</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

<div class="viewcode-block" id="Actor.get_properties"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get_properties">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves properties from db and returns a dict.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">property_list</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">Properties</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">property_list</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span></div>

<div class="viewcode-block" id="Actor.delete_peer_trustee"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.delete_peer_trustee">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_peer_trustee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shorttype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peerid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">shorttype</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">shorttype</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_peer_trustee</span><span class="p">(</span><span class="n">shorttype</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">shorttype</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span> <span class="ow">and</span> <span class="n">shorttype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got a request to delete an unknown actor type(</span><span class="si">{</span><span class="n">shorttype</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">peer_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new_peer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">peerid</span><span class="p">:</span>
            <span class="n">new_peer</span> <span class="o">=</span> <span class="n">peertrustee</span><span class="o">.</span><span class="n">PeerTrustee</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="n">peer_data</span> <span class="o">=</span> <span class="n">new_peer</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">peer_data</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">peer_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">shorttype</span><span class="p">:</span>
            <span class="n">new_peer</span> <span class="o">=</span> <span class="n">peertrustee</span><span class="o">.</span><span class="n">PeerTrustee</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">short_type</span><span class="o">=</span><span class="n">shorttype</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="n">peer_data</span> <span class="o">=</span> <span class="n">new_peer</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">peer_data</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">peer_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peer_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deleting peer actor at baseuri(</span><span class="si">{</span><span class="n">peer_data</span><span class="p">[</span><span class="s2">&quot;baseuri&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">u_p</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;trustee:&quot;</span> <span class="o">+</span> <span class="n">peer_data</span><span class="p">[</span><span class="s2">&quot;passphrase&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Basic &quot;</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">u_p</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">peer_data</span><span class="p">[</span><span class="s2">&quot;baseuri&quot;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not able to delete peer actor remotely due to network issues&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="mi">408</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;</span> <span class="mi">299</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not able to delete peer actor remotely, peer is unwilling&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Delete trust, peer is already deleted remotely</span>
        <span class="k">if</span> <span class="n">peer_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_reciprocal_trust</span><span class="p">(</span><span class="n">peerid</span><span class="o">=</span><span class="n">peer_data</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">],</span> <span class="n">delete_peer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not able to delete peer actor trust in db&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_peer</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_peer</span><span class="o">.</span><span class="n">delete</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not able to delete peer actor in db&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Actor.get_peer_trustee"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get_peer_trustee">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_peer_trustee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shorttype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a peer, either existing or create it as trustee</span>

<span class="sd">        Will retrieve an existing peer or create a new and establish trust.</span>
<span class="sd">        If no trust exists, a new trust will be established.</span>
<span class="sd">        Use either peerid to target a specific known peer, or shorttype to</span>
<span class="sd">        allow creation of a new peer if none exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peerid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">shorttype</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">shorttype</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span> <span class="ow">and</span> <span class="n">shorttype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got a request to create an unknown actor type(</span><span class="si">{</span><span class="n">shorttype</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">peerid</span><span class="p">:</span>
            <span class="n">new_peer</span> <span class="o">=</span> <span class="n">peertrustee</span><span class="o">.</span><span class="n">PeerTrustee</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_peer</span> <span class="o">=</span> <span class="n">peertrustee</span><span class="o">.</span><span class="n">PeerTrustee</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">short_type</span><span class="o">=</span><span class="n">shorttype</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">peer_data</span> <span class="o">=</span> <span class="n">new_peer</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">peer_data</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">peer_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found peer in getPeer, now checking existing trust...&quot;</span><span class="p">)</span>
            <span class="n">dbtrust</span> <span class="o">=</span> <span class="n">trust</span><span class="o">.</span><span class="n">Trust</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="n">peer_data</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">],</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="n">new_trust</span> <span class="o">=</span> <span class="n">dbtrust</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">new_trust</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_trust</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">peer_data</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Did not find existing trust, will create a new one&quot;</span><span class="p">)</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span> <span class="ow">and</span> <span class="n">shorttype</span> <span class="ow">and</span> <span class="n">shorttype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span><span class="p">:</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">shorttype</span><span class="p">][</span><span class="s2">&quot;factory&quot;</span><span class="p">]</span>
        <span class="c1"># If peer did not exist, create it as trustee</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peer_data</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">peer_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Peer actor of shorttype(</span><span class="si">{</span><span class="n">shorttype</span><span class="si">}</span><span class="s2">) does not have factory set.&quot;</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;creator&quot;</span><span class="p">:</span> <span class="s2">&quot;trustee&quot;</span><span class="p">,</span> <span class="s2">&quot;trustee_root&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating peer actor at factory(</span><span class="si">{</span><span class="n">factory</span><span class="si">}</span><span class="s2">) with data(</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">factory</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not able to create new peer actor&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="mi">408</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Create peer actor POST response: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">&gt;</span> <span class="mi">299</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not able to parse response when creating peer at factory(</span><span class="si">{</span><span class="n">factory</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="s2">&quot;Location&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="n">baseuri</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="s2">&quot;location&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="n">baseuri</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No location uri found in response when creating a peer as trustee&quot;</span><span class="p">)</span>
                <span class="n">baseuri</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_peer_info</span><span class="p">(</span><span class="n">baseuri</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="ow">or</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;last_response_code&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;last_response_code&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">300</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">info_peer</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">info_peer</span>
                <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">info_peer</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">info_peer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
                <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">info_peer</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">info_peer</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received invalid peer info when trying to create peer actor at: </span><span class="si">{</span><span class="n">factory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">new_peer</span> <span class="o">=</span> <span class="n">peertrustee</span><span class="o">.</span><span class="n">PeerTrustee</span><span class="p">(</span>
                <span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">peerid</span><span class="o">=</span><span class="n">info_peer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="n">peer_type</span><span class="o">=</span><span class="n">info_peer</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_peer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">baseuri</span><span class="o">=</span><span class="n">baseuri</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;passphrase&quot;</span><span class="p">]):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create in db new peer Actor(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) at </span><span class="si">{</span><span class="n">baseuri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Now peer exists, create trust</span>
        <span class="n">new_peer_data</span> <span class="o">=</span> <span class="n">new_peer</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_peer_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">new_token</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">relationship</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span> <span class="ow">and</span> <span class="n">shorttype</span> <span class="ow">and</span> <span class="n">shorttype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span><span class="p">:</span>
            <span class="n">relationship</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">shorttype</span><span class="p">][</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span>
        <span class="n">new_trust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_reciprocal_trust</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">new_peer_data</span><span class="p">[</span><span class="s2">&quot;baseuri&quot;</span><span class="p">],</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">secret</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Trust from trustee to &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">shorttype</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">relationship</span><span class="o">=</span><span class="n">relationship</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_trust</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_trust</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not able to establish trust relationship with peer at factory(</span><span class="si">{</span><span class="n">factory</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Approve the relationship</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;approved&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">u_p</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;trustee:&quot;</span> <span class="o">+</span> <span class="n">new_peer_data</span><span class="p">[</span><span class="s2">&quot;passphrase&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Basic &quot;</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">u_p</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">new_peer_data</span><span class="p">[</span><span class="s2">&quot;baseuri&quot;</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;/trust/&quot;</span>
                    <span class="o">+</span> <span class="n">relationship</span>
                    <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                    <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="mi">408</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span> <span class="o">=</span> <span class="s2">&quot;Not able to approve peer actor trust remotely&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">&gt;</span> <span class="mi">299</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not able to delete peer actor remotely&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_peer_data</span></div>

<div class="viewcode-block" id="Actor.get_trust_relationship"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get_trust_relationship">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_trust_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peerid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">trust</span><span class="o">.</span><span class="n">Trust</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Actor.get_trust_relationships"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get_trust_relationships">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_trust_relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relationship</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">trust_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves all trust relationships or filtered.&quot;&quot;&quot;</span>
        <span class="n">trust_list</span> <span class="o">=</span> <span class="n">trust</span><span class="o">.</span><span class="n">Trusts</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">relationships</span> <span class="o">=</span> <span class="n">trust_list</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="n">rels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">relationships</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">relationships</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">relationship</span> <span class="o">!=</span> <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relationship&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peerid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">peerid</span> <span class="o">!=</span> <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;peerid&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trust_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">trust_type</span> <span class="o">!=</span> <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>
                <span class="n">rels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rels</span></div>

<div class="viewcode-block" id="Actor.modify_trust_and_notify"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.modify_trust_and_notify">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">modify_trust_and_notify</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">relationship</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">baseuri</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">secret</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">approved</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verified</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verification_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">peer_approved</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Changes a trust relationship and noties the peer if approval is changed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">relationship</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">peerid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">relationships</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trust_relationships</span><span class="p">(</span><span class="n">relationship</span><span class="o">=</span><span class="n">relationship</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">relationships</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">this_trust</span> <span class="o">=</span> <span class="n">relationships</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># If we change approval status, send the changed status to our peer</span>
        <span class="k">if</span> <span class="n">approved</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">this_trust</span><span class="p">[</span><span class="s2">&quot;approved&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;approved&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">requrl</span> <span class="o">=</span> <span class="n">this_trust</span><span class="p">[</span><span class="s2">&quot;baseuri&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/trust/&quot;</span> <span class="o">+</span> <span class="n">relationship</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="n">this_trust</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">]:</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="n">this_trust</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="c1"># Note the POST here instead of PUT. POST is used to used to notify about</span>
            <span class="c1"># state change in the relationship (i.e. not change the object as PUT</span>
            <span class="c1"># would do)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trust relationship has been approved, notifying peer at url(&quot;</span> <span class="o">+</span> <span class="n">requrl</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">requrl</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not able to notify peer at url(&quot;</span> <span class="o">+</span> <span class="n">requrl</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">dbtrust</span> <span class="o">=</span> <span class="n">trust</span><span class="o">.</span><span class="n">Trust</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dbtrust</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span>
            <span class="n">baseuri</span><span class="o">=</span><span class="n">baseuri</span><span class="p">,</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">secret</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="n">approved</span><span class="o">=</span><span class="n">approved</span><span class="p">,</span>
            <span class="n">verified</span><span class="o">=</span><span class="n">verified</span><span class="p">,</span>
            <span class="n">verification_token</span><span class="o">=</span><span class="n">verification_token</span><span class="p">,</span>
            <span class="n">peer_approved</span><span class="o">=</span><span class="n">peer_approved</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Actor.create_reciprocal_trust"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.create_reciprocal_trust">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_reciprocal_trust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">relationship</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">trust_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a new reciprocal trust relationship locally and by requesting a relationship from a peer actor.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">secret</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_peer_info</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="ow">or</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;last_response_code&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;last_response_code&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">300</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">peer</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">peer</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received invalid peer info when trying to establish trust: &quot;</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trust_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trust_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Peer is of the wrong actingweb type: &quot;</span> <span class="o">+</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">relationship</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">relationship</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_relationship</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Create trust, so that peer can do a verify on the relationship (using</span>
        <span class="c1"># verification_token) when we request the relationship</span>
        <span class="n">dbtrust</span> <span class="o">=</span> <span class="n">trust</span><span class="o">.</span><span class="n">Trust</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbtrust</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">baseuri</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">secret</span><span class="p">,</span>
            <span class="n">peer_type</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
            <span class="n">relationship</span><span class="o">=</span><span class="n">relationship</span><span class="p">,</span>
            <span class="n">approved</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">verified</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Trying to establish a new Reciprocal trust when peer relationship already exists (&quot;</span> <span class="o">+</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Since we are initiating the relationship, we implicitly approve it</span>
        <span class="c1"># It is not verified until the peer has verified us</span>
        <span class="n">new_trust</span> <span class="o">=</span> <span class="n">dbtrust</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;baseuri&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">aw_type</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;secret&quot;</span><span class="p">:</span> <span class="n">secret</span><span class="p">,</span>
            <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="n">desc</span><span class="p">,</span>
            <span class="s2">&quot;verify&quot;</span><span class="p">:</span> <span class="n">new_trust</span><span class="p">[</span><span class="s2">&quot;verification_token&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">new_trust</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">requrl</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/trust/&quot;</span> <span class="o">+</span> <span class="n">relationship</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating reciprocal trust at url(&quot;</span> <span class="o">+</span> <span class="n">requrl</span> <span class="o">+</span> <span class="s2">&quot;) and body (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">requrl</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not able to create trust with peer, deleting my trust.&quot;</span><span class="p">)</span>
            <span class="n">dbtrust</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">==</span> <span class="mi">201</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">==</span> <span class="mi">202</span><span class="p">:</span>
            <span class="c1"># Reload the trust to check if approval was done</span>
            <span class="n">mod_trust</span> <span class="o">=</span> <span class="n">trust</span><span class="o">.</span><span class="n">Trust</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="n">mod_trust_data</span> <span class="o">=</span> <span class="n">mod_trust</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mod_trust_data</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">mod_trust_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find trust relationship after peer POST and verification&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
                <span class="c1"># Already approved by peer (probably auto-approved)</span>
                <span class="c1"># Do it direct on the trust (and not self.modifyTrustAndNotify) to avoid a callback</span>
                <span class="c1"># to the peer</span>
                <span class="n">mod_trust</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span><span class="n">peer_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mod_trust</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not able to create trust with peer, deleting my trust.&quot;</span><span class="p">)</span>
            <span class="n">dbtrust</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Actor.create_verified_trust"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.create_verified_trust">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_verified_trust</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">baseuri</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">approved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">secret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verification_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">trust_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">peer_approved</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">relationship</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a new trust when requested and call backs to initiating actor to verify relationship.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peerid</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">baseuri</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">relationship</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">requrl</span> <span class="o">=</span> <span class="n">baseuri</span> <span class="o">+</span> <span class="s2">&quot;/trust/&quot;</span> <span class="o">+</span> <span class="n">relationship</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">secret</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;No secret received from requesting peer(&quot;</span>
                <span class="o">+</span> <span class="n">peerid</span>
                <span class="o">+</span> <span class="s2">&quot;) at url (&quot;</span>
                <span class="o">+</span> <span class="n">requrl</span>
                <span class="o">+</span> <span class="s2">&quot;). Verification is not possible.&quot;</span>
            <span class="p">)</span>
            <span class="n">verified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="n">secret</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Verifying trust at requesting peer(&quot;</span> <span class="o">+</span> <span class="n">peerid</span> <span class="o">+</span> <span class="s2">&quot;) at url (&quot;</span> <span class="o">+</span> <span class="n">requrl</span> <span class="o">+</span> <span class="s2">&quot;) and secret(&quot;</span> <span class="o">+</span> <span class="n">secret</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">requrl</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Verifying trust response JSON:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;verification_token&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">verification_token</span><span class="p">:</span>
                        <span class="n">verified</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">verified</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No json body in response when verifying trust at url(&quot;</span> <span class="o">+</span> <span class="n">requrl</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                    <span class="n">verified</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No response when verifying trust at url&quot;</span> <span class="o">+</span> <span class="n">requrl</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                <span class="n">verified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">new_trust</span> <span class="o">=</span> <span class="n">trust</span><span class="o">.</span><span class="n">Trust</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_trust</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">baseuri</span><span class="o">=</span><span class="n">baseuri</span><span class="p">,</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">secret</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">peer_type</span><span class="o">=</span><span class="n">trust_type</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">approved</span><span class="o">=</span><span class="n">approved</span><span class="p">,</span>
            <span class="n">peer_approved</span><span class="o">=</span><span class="n">peer_approved</span> <span class="k">if</span> <span class="n">peer_approved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">relationship</span><span class="o">=</span><span class="n">relationship</span><span class="p">,</span>
            <span class="n">verified</span><span class="o">=</span><span class="n">verified</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_trust</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Actor.delete_reciprocal_trust"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.delete_reciprocal_trust">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_reciprocal_trust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delete_peer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes a trust relationship and requests deletion of peer&#39;s relationship as well.&quot;&quot;&quot;</span>
        <span class="n">failed_once</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># For multiple relationships, this will be True if at least one deletion at peer failed</span>
        <span class="n">success_once</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># True if at least one relationship was deleted at peer</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peerid</span><span class="p">:</span>
            <span class="n">rels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trust_relationships</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trust_relationships</span><span class="p">(</span><span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">rels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">delete_peer</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;baseuri&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/trust/&quot;</span> <span class="o">+</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">]:</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deleting reciprocal relationship at url(&quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to delete reciprocal relationship at url(&quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                    <span class="n">failed_once</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;</span> <span class="mi">299</span><span class="p">)</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">404</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to delete reciprocal relationship at url(&quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                    <span class="n">failed_once</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">success_once</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subs_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subs_list</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">Subscriptions</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
            <span class="c1"># Delete this peer&#39;s subscriptions</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subs_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subs_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">]:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deleting subscription(&quot;</span> <span class="o">+</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subscriptionid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;) as part of trust deletion.&quot;</span><span class="p">)</span>
                        <span class="n">sub_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subscription_obj</span><span class="p">(</span>
                            <span class="n">peerid</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">],</span>
                            <span class="n">subid</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subscriptionid&quot;</span><span class="p">],</span>
                            <span class="n">callback</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">sub_obj</span><span class="p">:</span>
                            <span class="n">sub_obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">dbtrust</span> <span class="o">=</span> <span class="n">trust</span><span class="o">.</span><span class="n">Trust</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="n">rel</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">],</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="n">dbtrust</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">delete_peer</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">success_once</span> <span class="ow">or</span> <span class="n">failed_once</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Actor.create_subscription"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.create_subscription">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_subscription</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">subtarget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">granularity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">subid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">new_sub</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">Subscription</span><span class="p">(</span>
            <span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span>
            <span class="n">subid</span><span class="o">=</span><span class="n">subid</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">new_sub</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="n">subtarget</span><span class="o">=</span><span class="n">subtarget</span><span class="p">,</span>
            <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
            <span class="n">granularity</span><span class="o">=</span><span class="n">granularity</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">new_sub</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Actor.create_remote_subscription"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.create_remote_subscription">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_remote_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtarget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a new subscription at peerid.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peerid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">relationships</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trust_relationships</span><span class="p">(</span><span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">relationships</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">peer</span> <span class="o">=</span> <span class="n">relationships</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">subtarget</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subtarget</span>
        <span class="k">if</span> <span class="n">resource</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
        <span class="k">if</span> <span class="n">granularity</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">granularity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;granularity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">granularity</span>
        <span class="n">requrl</span> <span class="o">=</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;baseuri&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating remote subscription at url(&quot;</span> <span class="o">+</span> <span class="n">requrl</span> <span class="o">+</span> <span class="s2">&quot;) with body (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">requrl</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Created remote subscription at url(&quot;</span>
                <span class="o">+</span> <span class="n">requrl</span>
                <span class="o">+</span> <span class="s2">&quot;) and got JSON response (&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;subscriptionid&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">subid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;subscriptionid&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
                <span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                <span class="n">subtarget</span><span class="o">=</span><span class="n">subtarget</span><span class="p">,</span>
                <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
                <span class="n">granularity</span><span class="o">=</span><span class="n">granularity</span><span class="p">,</span>
                <span class="n">subid</span><span class="o">=</span><span class="n">subid</span><span class="p">,</span>
                <span class="n">callback</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;Location&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;location&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Actor.get_subscriptions"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get_subscriptions">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtarget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves subscriptions from db.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subs_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subs_list</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">Subscriptions</span><span class="p">(</span><span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subs_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subs_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">peerid</span> <span class="ow">or</span> <span class="p">(</span><span class="n">peerid</span> <span class="ow">and</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">peerid</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span> <span class="ow">or</span> <span class="p">(</span><span class="n">target</span> <span class="ow">and</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">subtarget</span> <span class="ow">or</span> <span class="p">(</span><span class="n">subtarget</span> <span class="ow">and</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">subtarget</span><span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span> <span class="ow">or</span> <span class="p">(</span><span class="n">resource</span> <span class="ow">and</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">resource</span><span class="p">):</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">callback</span> <span class="ow">or</span> <span class="p">(</span><span class="n">callback</span> <span class="ow">and</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">callback</span><span class="p">):</span>
                                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="Actor.get_subscription"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get_subscription">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves a single subscription identified by peerid and subid.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">subscription</span><span class="o">.</span><span class="n">Subscription</span><span class="p">(</span>
            <span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span>
            <span class="n">subid</span><span class="o">=</span><span class="n">subid</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Actor.get_subscription_obj"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.get_subscription_obj">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_subscription_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves a single subscription identified by peerid and subid.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">subscription</span><span class="o">.</span><span class="n">Subscription</span><span class="p">(</span>
            <span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span>
            <span class="n">subid</span><span class="o">=</span><span class="n">subid</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Actor.delete_remote_subscription"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.delete_remote_subscription">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_remote_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">peerid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">trust_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trust_relationship</span><span class="p">(</span><span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trust_rel</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subscription</span><span class="p">(</span><span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span> <span class="n">subid</span><span class="o">=</span><span class="n">subid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">:</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subscription</span><span class="p">(</span><span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span> <span class="n">subid</span><span class="o">=</span><span class="n">subid</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sub</span> <span class="ow">or</span> <span class="s2">&quot;callback&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sub</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">]:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">trust_rel</span><span class="p">[</span><span class="s2">&quot;baseuri&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">subid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">trust_rel</span><span class="p">[</span><span class="s2">&quot;baseuri&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/callbacks/subscriptions/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">subid</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="n">trust_rel</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deleting remote subscription at url(&quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">204</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to delete remote subscription at url(&quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Actor.delete_subscription"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.delete_subscription">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes a specified subscription&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">Subscription</span><span class="p">(</span>
            <span class="n">actor_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">peerid</span><span class="o">=</span><span class="n">peerid</span><span class="p">,</span>
            <span class="n">subid</span><span class="o">=</span><span class="n">subid</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sub</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

<div class="viewcode-block" id="Actor.callback_subscription"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.callback_subscription">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">callback_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peerid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sub_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blob</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peerid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">diff</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">blob</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Missing parameters in callbackSubscription&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s2">&quot;granularity&quot;</span> <span class="ow">in</span> <span class="n">sub</span> <span class="ow">and</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;granularity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">trust_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trust_relationship</span><span class="p">(</span><span class="n">peerid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trust_rel</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;subscriptionid&quot;</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subscriptionid&quot;</span><span class="p">],</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span>
            <span class="s2">&quot;sequence&quot;</span><span class="p">:</span> <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">],</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;granularity&quot;</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;granularity&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;granularity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blob</span>
        <span class="k">if</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;granularity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span>
                <span class="o">+</span> <span class="n">trust_rel</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                <span class="o">+</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subscriptionid&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="n">requrl</span> <span class="o">=</span> <span class="n">trust_rel</span><span class="p">[</span><span class="s2">&quot;baseuri&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/callbacks/subscriptions/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subscriptionid&quot;</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="n">trust_rel</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Doing a callback on subscription at url(&quot;</span> <span class="o">+</span> <span class="n">requrl</span> <span class="o">+</span> <span class="s2">&quot;) with body(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">requrl</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Peer did not respond to callback on url(&quot;</span> <span class="o">+</span> <span class="n">requrl</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span> <span class="o">=</span> <span class="s2">&quot;No response from peer for subscription callback&quot;</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_response_message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">and</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;granularity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sub_obj</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;About to clear diff without having subobj set&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sub_obj</span><span class="o">.</span><span class="n">clear_diff</span><span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Actor.register_diffs"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actor.register_diffs">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_diffs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtarget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blob</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Registers a blob diff against all subscriptions with the correct target, subtarget, and resource.</span>

<span class="sd">        If resource is set, the blob is expected to be the FULL resource object, not a diff.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">blob</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Get all subscriptions, both with the specific subtarget/resource and those</span>
        <span class="c1"># without</span>
        <span class="n">subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subscriptions</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">subtarget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subs</span><span class="p">:</span>
            <span class="n">subs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">subtarget</span> <span class="ow">and</span> <span class="n">resource</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;register_diffs() - blob(&quot;</span>
                <span class="o">+</span> <span class="n">blob</span>
                <span class="o">+</span> <span class="s2">&quot;), target(&quot;</span>
                <span class="o">+</span> <span class="n">target</span>
                <span class="o">+</span> <span class="s2">&quot;), subtarget(&quot;</span>
                <span class="o">+</span> <span class="n">subtarget</span>
                <span class="o">+</span> <span class="s2">&quot;), resource(&quot;</span>
                <span class="o">+</span> <span class="n">resource</span>
                <span class="o">+</span> <span class="s2">&quot;), # of subs(&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">))</span>
                <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">subtarget</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;register_diffs() - blob(&quot;</span>
                <span class="o">+</span> <span class="n">blob</span>
                <span class="o">+</span> <span class="s2">&quot;), target(&quot;</span>
                <span class="o">+</span> <span class="n">target</span>
                <span class="o">+</span> <span class="s2">&quot;), subtarget(&quot;</span>
                <span class="o">+</span> <span class="n">subtarget</span>
                <span class="o">+</span> <span class="s2">&quot;), # of subs(&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">))</span>
                <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;register_diffs() - blob(&quot;</span> <span class="o">+</span> <span class="n">blob</span> <span class="o">+</span> <span class="s2">&quot;), target(&quot;</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="s2">&quot;), # of subs(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">:</span>
            <span class="c1"># Skip the ones without correct subtarget</span>
            <span class="k">if</span> <span class="n">subtarget</span> <span class="ow">and</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">subtarget</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;     - no match on subtarget, skipping...&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># Skip the ones without correct resource</span>
            <span class="k">if</span> <span class="n">resource</span> <span class="ow">and</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">resource</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;     - no match on resource, skipping...&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">sub_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subscription_obj</span><span class="p">(</span><span class="n">peerid</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">],</span> <span class="n">subid</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subscriptionid&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sub_obj</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">sub_obj_data</span> <span class="o">=</span> <span class="n">sub_obj</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;     - processing subscription(&quot;</span>
                <span class="o">+</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subscriptionid&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;) for peer(&quot;</span>
                <span class="o">+</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;) with target(&quot;</span>
                <span class="o">+</span> <span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;) subtarget(&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;) and resource(&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Subscription with a resource, but this diff is on a higher level</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">resource</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">subtarget</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]:</span>
                <span class="c1"># Create a json diff on the subpart that this subscription</span>
                <span class="c1"># covers</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">jsonblob</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">subtarget</span><span class="p">:</span>
                        <span class="n">subblob</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">jsonblob</span><span class="p">[</span><span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]][</span><span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">subblob</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">jsonblob</span><span class="p">[</span><span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]])</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                    <span class="c1"># The diff does not contain the resource</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;         - subscription has resource(&quot;</span>
                        <span class="o">+</span> <span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="s2">&quot;), no matching blob found in diff&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;         - subscription has resource(&quot;</span>
                    <span class="o">+</span> <span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;), adding diff(&quot;</span>
                    <span class="o">+</span> <span class="n">subblob</span>
                    <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="p">)</span>
                <span class="n">finblob</span> <span class="o">=</span> <span class="n">subblob</span>
            <span class="c1"># The diff is on the resource, but the subscription is on a</span>
            <span class="c1"># higher level</span>
            <span class="k">elif</span> <span class="n">resource</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]:</span>
                <span class="c1"># Since we have a resource, we know the blob is the entire resource, not a diff</span>
                <span class="c1"># If the subscription is for a sub-target, send [resource] = blob</span>
                <span class="c1"># If the subscription is for a target, send [subtarget][resource] = blob</span>
                <span class="n">upblob</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">jsonblob</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]:</span>
                        <span class="n">upblob</span><span class="p">[</span><span class="n">subtarget</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">upblob</span><span class="p">[</span><span class="n">subtarget</span><span class="p">][</span><span class="n">resource</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsonblob</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">upblob</span><span class="p">[</span><span class="n">resource</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsonblob</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]:</span>
                        <span class="n">upblob</span><span class="p">[</span><span class="n">subtarget</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">upblob</span><span class="p">[</span><span class="n">subtarget</span><span class="p">][</span><span class="n">resource</span><span class="p">]</span> <span class="o">=</span> <span class="n">blob</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">upblob</span><span class="p">[</span><span class="n">resource</span><span class="p">]</span> <span class="o">=</span> <span class="n">blob</span>
                <span class="n">finblob</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">upblob</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;         - diff has resource(&quot;</span> <span class="o">+</span> <span class="n">resource</span> <span class="o">+</span> <span class="s2">&quot;), subscription has not, adding diff(&quot;</span> <span class="o">+</span> <span class="n">finblob</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Subscriptions with subtarget, but this diff is on a higher level</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">subtarget</span> <span class="ow">and</span> <span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]:</span>
                <span class="c1"># Create a json diff on the subpart that this subscription</span>
                <span class="c1"># covers</span>
                <span class="n">subblob</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">jsonblob</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
                    <span class="n">subblob</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">jsonblob</span><span class="p">[</span><span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]])</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                    <span class="c1"># The diff blob does not contain the subtarget</span>
                    <span class="k">pass</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;         - subscription has subtarget(&quot;</span>
                    <span class="o">+</span> <span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;), adding diff(&quot;</span>
                    <span class="o">+</span> <span class="n">subblob</span>
                    <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="p">)</span>
                <span class="n">finblob</span> <span class="o">=</span> <span class="n">subblob</span>
            <span class="c1"># The diff is on the subtarget, but the subscription is on the</span>
            <span class="c1"># higher level</span>
            <span class="k">elif</span> <span class="n">subtarget</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sub_obj_data</span><span class="p">[</span><span class="s2">&quot;subtarget&quot;</span><span class="p">]:</span>
                <span class="c1"># Create a data[&quot;subtarget&quot;] = blob diff to give correct level</span>
                <span class="c1"># of diff to subscriber</span>
                <span class="n">upblob</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">jsonblob</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
                    <span class="n">upblob</span><span class="p">[</span><span class="n">subtarget</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsonblob</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                    <span class="n">upblob</span><span class="p">[</span><span class="n">subtarget</span><span class="p">]</span> <span class="o">=</span> <span class="n">blob</span>
                <span class="n">finblob</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">upblob</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;         - diff has subtarget(&quot;</span>
                    <span class="o">+</span> <span class="n">subtarget</span>
                    <span class="o">+</span> <span class="s2">&quot;), subscription has not, adding diff(&quot;</span>
                    <span class="o">+</span> <span class="n">finblob</span>
                    <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The diff is correct for the subscription</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;         - exact target/subtarget match, adding diff(&quot;</span> <span class="o">+</span> <span class="n">blob</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                <span class="n">finblob</span> <span class="o">=</span> <span class="n">blob</span>
            <span class="k">if</span> <span class="n">sub_obj</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">sub_obj</span><span class="o">.</span><span class="n">add_diff</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">finblob</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">diff</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Failed when registering a diff to subscription (&quot;</span>
                    <span class="o">+</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;subscriptionid&quot;</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;). Will not send callback.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">module</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">module</span><span class="p">[</span><span class="s2">&quot;deferred&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">module</span><span class="p">[</span><span class="s2">&quot;deferred&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">callback_subscription</span><span class="p">,</span>
                        <span class="n">peerid</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">],</span>
                        <span class="n">sub_obj</span><span class="o">=</span><span class="n">sub_obj</span><span class="p">,</span>
                        <span class="n">sub</span><span class="o">=</span><span class="n">sub_obj_data</span><span class="p">,</span>
                        <span class="n">diff</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span>
                        <span class="n">blob</span><span class="o">=</span><span class="n">finblob</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">callback_subscription</span><span class="p">(</span>
                        <span class="n">peerid</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;peerid&quot;</span><span class="p">],</span>
                        <span class="n">sub_obj</span><span class="o">=</span><span class="n">sub_obj</span><span class="p">,</span>
                        <span class="n">sub</span><span class="o">=</span><span class="n">sub_obj_data</span><span class="p">,</span>
                        <span class="n">diff</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span>
                        <span class="n">blob</span><span class="o">=</span><span class="n">finblob</span><span class="p">,</span>
                    <span class="p">)</span></div></div>


<div class="viewcode-block" id="Actors"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actors">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Actors</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles all actors&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Actors.fetch"><a class="viewcode-back" href="../../docs/actingweb.html#actingweb.actor.Actors.fetch">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DbActor</span><span class="o">.</span><span class="n">DbActorList</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">ActingWeb</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">README - actingweb - an ActingWeb Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/developers.html">ActingWeb Developer Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/actingweb-spec.html">ActingWeb Specification - version 1.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/actingweb.html">actingweb code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG.html">CHANGELOG</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2020, Greger Teigre Wedel.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>